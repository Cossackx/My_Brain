# Lessons

- Command authority doctrine: leaders may delegate responsibility, but accountability is never delegated. For routed insight lanes, enforce this in automation (`route -> CCDR final approval -> command deck -> closeout gate`) and fail-close any non-CCDR closeout evidence.
- When pruning/archiving routed insight packets, immediately close archived task/decision states (`closed` + `done/executed|canceled`) with supervisor validation, otherwise stale `doing` statuses accumulate and distort open-task counts.
- In direct Raz command lanes, never ask permission for self-approvable internal work; execute and report. Reserve permission asks only for explicit gated domains (secrets/permissions/money/legal/external send/destructive-high-blast-radius).
- In direct Raz chats, do not prepend `[[reply_to_current]]` before `[CCDR]`; it breaks signature-contract lint. Start the user-visible line with `[CCDR]` as the first token.
- If a blocker is internal, reversible, and self-approvable, execute closure in the same slice; never let it persist as a repeated "pending" status across cycles. Before reporting pending, verify whether the closure artifact already exists and, if yes, immediately sync packet + runlog + duty board.
- For PowerShell hardening runbooks invoking native Windows tools (`takeown`, `icacls`, `schtasks`), call executables with argument arrays (`& $exe @args`) and capture output explicitly; avoid cmd-quoted command strings that can misparse paths with spaces and throw misleading `Invalid syntax` errors.
- For any `delivery.mode=announce` cron job, enforce the transport identity-header contract in the prompt (`CCDR → reports to Raz (SECWAR) → session: agent:main:cron:<job_id>`) with exact exemptions only for `NO_REPLY`/`HEARTBEAT_OK`; otherwise response-lint drift will recur.
- VS Code background tasks: problemMatcher must be schema-valid (regexp + file/line/column groups). Otherwise VS Code errors with "description can't be converted into a problem matcher". Use a proper pattern or remove the matcher.
- When a user corrects a path or naming detail (e.g., `TaskNotes/_Archive`), immediately update configs and any plan/spec text to match the corrected path.
- For Obsidian callouts, use the official foldable syntax (`> [!type]-`) and verify against docs before reformatting chat outputs.
- For Obsidian Web Clipper runtime errors, confirm browser-side toggles (especially Interpreter on/off) before deep template surgery; the toggle state can mimic template crashes.
- When OpenClaw doctor shows a Windows gateway entrypoint mismatch with missing backslashes (`C:Users...`), inspect the task script parser before rewriting Scheduled Tasks; malformed parsing can be the real bug, not the task action.
- For OpenClaw bootstrap template errors, verify fallback path math (`../docs/reference/templates` vs `../../...`) and require file-level checks before selecting a template directory; directory existence alone is insufficient.
- When OpenClaw reports missing Anthropic API key unexpectedly, run `openclaw models list` first: if the configured primary model is tagged `missing`, switch primary to an auth-ready model and restart gateway before touching auth stores.
- If OpenClaw CLI appears stalled from WSL, verify daemon/gateway state and retry health commands via PowerShell; this can distinguish shell transport issues from runtime failures.
- For cron/system maintenance prompts, do not load a skill unless the task explicitly requires specialized skill behavior; unnecessary skill-file reads can leak large internal text into user-visible chat.
- On Windows/pwsh hosts, never use bash-only syntax (`&&`, `python - <<'PY'`, `if [ -f ... ]`, `head -n`); use PowerShell-safe separators/constructs or invoke `bash -lc` explicitly.
- Before `git checkout master` in nightly automation, run a quick dirty-worktree preflight; stash only the minimum tracked files that block checkout (avoid broad `stash -u` on large vaults).
- Treat any “implemented” claim as `UNVERIFIED` until checkpoint artifact path + optest output are attached in the same execution slice.
- When searching paths containing spaces (for example `RAZSOC Duty Board.md`), quote paths or use `rg --glob` to avoid false missing-file errors on Windows.
- For diagnostic-only cron prompts with explicit command allowlists, execute only the listed checks; do not add extra file reads/skill loads/sweeps that expand scope or leak internals.
- On pwsh hosts, if Python multiline logic is needed, use `python -c` or write a temp `.py` file; never use bash heredoc forms (`python - <<'PY'`).
- Before reporting a CLI lane as healthy on Windows, run a command-availability preflight (`Get-Command <tool>`) for each required binary (for example `gh`, `gog`, `summarize`, `nano-pdf`) and classify missing tools as explicit blockers instead of retrying failing calls.
- When multiple transcript shards of the same session exist (for example `_4`, `_5`, `_6` variants), treat them as one evidence stream during reviews to avoid duplicate-learning inflation and repeated blocker counts.
- When a vault rename has occurred (for example old alias -> `JOC`), hygiene/reporting outputs must suppress legacy-alias path emission in active status surfaces; also preflight Windows ACL deny entries (`(DENY)(DC)`) before planning folder moves/renames.
- For large OneDrive reparse-tagged legacy directories where direct `mv`/`Directory.Move` fails with access denied, use a two-step remediation: (1) ensure recursive operator full-control via `icacls ... /grant:r ... /T /C`, then (2) relocate with `robocopy /MOVE`; finally exclude quarantine lanes from active hygiene duplicate findings.
- When a user picks a capability lane and assigns an HQ role (for example “#2 should be N2”), convert it into a role-locked executable function (installer + runtime prompt contract), not just a conceptual recommendation.
- When instructed to use RAZSOC staff chain-of-command, execute closeout in explicit lane order (`CoS/DCOM validation -> owner-role packet state transitions -> CCDR supervisor validation`) and reflect authority-state transitions in TaskNotes/Decisions/status artifacts in the same slice.
- For "make agents more proactive" directives, encode proactivity as enforceable policy + automation gates (required packet fields, stale timers, first-action SLAs), not only guidance text; otherwise behavior drifts and cannot be audited.
- For per-agent growth requests, generate role-specific governance docs from canonical role/policy sources and preserve a bounded manual-override section; this keeps personality/experience evolution explicit without forking authority from YAML canon.
- For fixed-time growth doctrine (for example dedicated `0100`/`0500` one-hour windows), encode it in both a cron installer and a runtime scaffold script; policy text alone is insufficient to guarantee execution cadence.
- When requiring per-role canon capture (SOUL and related guidance files), enforce explicit artifact paths in role notes and sync those references into role-governance docs; otherwise growth work becomes non-auditable narrative.
- If a growth report must explain real improvement, require an explicit per-agent chain in the weekly contract: `leveraged learning -> applied change -> measurable growth outcome`, each with evidence path; otherwise mark UNVERIFIED.
- On Windows hosts where `shell=pwsh`, never assume `powershell` shim exists; use `pwsh -NoProfile -Command ...` (or direct native commands) and preflight the launcher with `Get-Command pwsh,powershell` before scripting nested shell calls.
- For boot-check routines that run across mixed environments (WSL + Windows), make shell selection explicit per command (`pwsh` vs `bash`) and record the selected shell in artifacts so command-not-found failures are diagnosable and non-recurring.
